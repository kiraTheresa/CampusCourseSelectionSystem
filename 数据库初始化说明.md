# 数据库初始化说明

本文档说明如何初始化校园选课管理系统的数据库。

## 目录

- [快速开始](#快速开始)
- [初始化方式](#初始化方式)
  - [方式一：使用初始化脚本（推荐）](#方式一使用初始化脚本推荐)
  - [方式二：手动初始化](#方式二手动初始化)
  - [方式三：使用 JPA 自动创建（开发环境）](#方式三使用-jpa-自动创建开发环境)
- [环境配置](#环境配置)
- [常见问题](#常见问题)

---

## 快速开始

### 使用初始化脚本（最简单）

```bash
# 1. 给脚本添加执行权限
chmod +x init-database.sh

# 2. 运行初始化脚本（使用默认配置）
./init-database.sh

# 3. 或者指定数据库密码
./init-database.sh -p your_password
```

### 使用 JPA 自动创建（开发环境）

```bash
# 直接启动应用，JPA 会自动创建表结构
mvn spring-boot:run
```

---

## 初始化方式

### 方式一：使用初始化脚本（推荐）

初始化脚本 `init-database.sh` 可以自动完成数据库创建和表结构初始化。

#### 1. 脚本功能

- ✅ 自动检测 MySQL 客户端是否安装
- ✅ 测试数据库连接
- ✅ 创建数据库（如果不存在）
- ✅ 执行表结构初始化（schema.sql）
- ✅ 可选执行测试数据初始化（data.sql）

#### 2. 使用步骤

**步骤 1：添加执行权限**

```bash
chmod +x init-database.sh
```

**步骤 2：配置数据库连接信息**

可以通过以下方式配置：

**方式 A：使用命令行参数**

```bash
./init-database.sh -H localhost -P 3306 -d campus_course_selection_system -u root -p your_password
```

**方式 B：使用环境变量**

```bash
export DB_HOST=localhost
export DB_PORT=3306
export DB_NAME=campus_course_selection_system
export DB_USER=root
export DB_PASSWORD=your_password
./init-database.sh
```

**方式 C：使用默认配置**

```bash
# 默认配置：
# - 主机: localhost
# - 端口: 3306
# - 数据库名: campus_course_selection_system
# - 用户名: root
# - 密码: root
./init-database.sh
```

**步骤 3：运行脚本**

```bash
./init-database.sh
```

脚本会提示是否导入测试数据，可以选择：
- 输入 `y` 或 `Y` 导入测试数据
- 输入其他键或直接回车跳过测试数据

#### 3. 脚本参数说明

| 参数 | 长参数 | 说明 | 默认值 |
|------|--------|------|--------|
| `-h` | `--help` | 显示帮助信息 | - |
| `-H` | `--host` | 数据库主机地址 | localhost |
| `-P` | `--port` | 数据库端口 | 3306 |
| `-d` | `--database` | 数据库名称 | campus_course_selection_system |
| `-u` | `--user` | 数据库用户名 | root |
| `-p` | `--password` | 数据库密码 | root |

#### 4. 使用示例

```bash
# 示例 1: 使用默认配置
./init-database.sh

# 示例 2: 指定密码
./init-database.sh -p mypassword123

# 示例 3: 指定所有参数
./init-database.sh -H 192.168.1.100 -P 3306 -d mydb -u admin -p secret

# 示例 4: 使用环境变量
DB_PASSWORD=mypassword DB_NAME=mydb ./init-database.sh

# 示例 5: 查看帮助
./init-database.sh --help
```

---

### 方式二：手动初始化

如果不想使用脚本，可以手动执行 SQL 命令。

#### 1. 登录 MySQL

```bash
mysql -u root -p
```

#### 2. 创建数据库

```sql
CREATE DATABASE IF NOT EXISTS campus_course_selection_system
    CHARACTER SET utf8mb4
    COLLATE utf8mb4_unicode_ci;
```

#### 3. 使用数据库

```sql
USE campus_course_selection_system;
```

#### 4. 执行表结构脚本

```sql
SOURCE /path/to/project/src/main/resources/db/schema.sql;
```

或者使用命令行：

```bash
mysql -u root -p campus_course_selection_system < src/main/resources/db/schema.sql
```

#### 5. （可选）导入测试数据

```bash
mysql -u root -p campus_course_selection_system < src/main/resources/db/data.sql
```

---

### 方式三：使用 JPA 自动创建（开发环境）

开发环境默认使用 H2 内存数据库，JPA 会自动创建表结构，无需手动初始化。

#### 配置说明

在 `application-dev.yml` 中：

```yaml
spring:
  jpa:
    hibernate:
      ddl-auto: update  # 自动创建/更新表结构
  sql:
    init:
      mode: always  # 自动执行初始化脚本
```

#### 使用步骤

1. 确保使用开发环境配置：
   ```bash
   mvn spring-boot:run
   # 或者
   export SPRING_PROFILES_ACTIVE=dev
   mvn spring-boot:run
   ```

2. 应用启动时会自动：
   - 创建 H2 内存数据库
   - 根据实体类自动创建表结构
   - 执行 `db/data.sql` 中的测试数据

3. 访问 H2 控制台查看数据：
   - URL: `http://localhost:8080/h2-console`
   - JDBC URL: `jdbc:h2:mem:testdb`
   - 用户名: `sa`
   - 密码: （空）

**注意**：H2 是内存数据库，应用重启后数据会丢失。

---

## 环境配置

### 开发环境（H2）

**优点**：
- ✅ 无需安装数据库
- ✅ 自动初始化
- ✅ 适合快速开发测试

**缺点**：
- ❌ 数据不持久化（重启后丢失）
- ❌ 不支持生产环境

**配置**：
- 使用默认配置或设置 `SPRING_PROFILES_ACTIVE=dev`
- 无需手动初始化数据库

### 生产环境（MySQL）

**优点**：
- ✅ 数据持久化
- ✅ 性能稳定
- ✅ 适合生产部署

**缺点**：
- ❌ 需要安装 MySQL
- ❌ 需要手动初始化

**配置步骤**：

1. **初始化数据库**（使用脚本或手动）：
   ```bash
   ./init-database.sh -p your_password
   ```

2. **配置应用连接**（修改 `application-prod.yml` 或使用环境变量）：
   ```yaml
   spring:
     datasource:
       url: jdbc:mysql://localhost:3306/campus_course_selection_system
       username: ${DB_USERNAME:root}
       password: ${DB_PASSWORD:your_password}
   ```

3. **启动应用**：
   ```bash
   export SPRING_PROFILES_ACTIVE=prod
   mvn spring-boot:run
   ```

---

## 常见问题

### Q1: 脚本执行失败，提示 "MySQL 客户端未安装"

**解决方案**：
- **Ubuntu/Debian**:
  ```bash
  sudo apt-get update
  sudo apt-get install mysql-client
  ```
- **CentOS/RHEL**:
  ```bash
  sudo yum install mysql
  ```
- **macOS**:
  ```bash
  brew install mysql-client
  ```

### Q2: 连接数据库失败

**可能原因**：
1. MySQL 服务未启动
2. 用户名或密码错误
3. 数据库主机或端口不正确

**解决方案**：
```bash
# 检查 MySQL 服务状态
sudo systemctl status mysql  # Linux
brew services list | grep mysql  # macOS

# 测试连接
mysql -h localhost -P 3306 -u root -p
```

### Q3: 表结构已存在，需要重新初始化

**解决方案**：

```bash
# 方式 1: 删除数据库重新创建（会丢失所有数据）
mysql -u root -p -e "DROP DATABASE IF EXISTS campus_course_selection_system;"
./init-database.sh

# 方式 2: 手动删除表
mysql -u root -p campus_course_selection_system -e "DROP TABLE IF EXISTS enrollments, courses, students;"
./init-database.sh
```

### Q4: 如何只创建表结构，不导入测试数据？

**解决方案**：
运行脚本时，当提示 "是否导入测试数据？(y/N)" 时，直接回车或输入 `n`。

### Q5: 如何验证数据库初始化是否成功？

**解决方案**：

```bash
# 1. 检查数据库是否存在
mysql -u root -p -e "SHOW DATABASES LIKE 'campus_course_selection_system';"

# 2. 检查表是否创建
mysql -u root -p campus_course_selection_system -e "SHOW TABLES;"

# 3. 检查表结构
mysql -u root -p campus_course_selection_system -e "DESCRIBE courses;"

# 4. 使用健康检查接口（应用启动后）
curl http://localhost:8080/health/db
```

### Q6: Windows 系统如何使用初始化脚本？

**解决方案**：

**方式 1：使用 Git Bash**（推荐）
- 安装 Git for Windows（自带 Git Bash）
- 在 Git Bash 中运行 `./init-database.sh`

**方式 2：使用 WSL**
```bash
# 在 WSL 中运行
bash init-database.sh
```

**方式 3：手动执行 SQL**
```bash
# 使用 MySQL 命令行工具
mysql -u root -p < src/main/resources/db/schema.sql
```

### Q7: 生产环境需要设置哪些安全配置？

**建议配置**：

1. **创建专用数据库用户**（不使用 root）：
   ```sql
   CREATE USER 'app_user'@'localhost' IDENTIFIED BY 'strong_password';
   GRANT ALL PRIVILEGES ON campus_course_selection_system.* TO 'app_user'@'localhost';
   FLUSH PRIVILEGES;
   ```

2. **使用环境变量存储密码**：
   ```bash
   export DB_PASSWORD=strong_password
   ./init-database.sh -u app_user
   ```

3. **配置应用使用环境变量**：
   ```yaml
   spring:
     datasource:
       username: ${DB_USERNAME}
       password: ${DB_PASSWORD}
   ```

---

## 下一步

数据库初始化完成后：

1. ✅ 验证数据库连接：`curl http://localhost:8080/health/db`
2. ✅ 查看 API 文档：访问 `http://localhost:8080` 查看接口
3. ✅ 开始使用系统：参考 `README.md` 中的 API 接口说明

---

## 相关文件

- `init-database.sh` - 数据库初始化脚本
- `src/main/resources/db/schema.sql` - 表结构定义
- `src/main/resources/db/data.sql` - 测试数据（可选）
- `src/main/resources/application-prod.yml` - 生产环境配置
- `src/main/resources/application-dev.yml` - 开发环境配置
- `README.md` - 项目主文档

---

**如有问题，请参考项目主文档 `README.md` 或提交 Issue。**

